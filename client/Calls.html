<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PEERAS</title>
    <script src="/peeras.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="/kyoCall/style.css">
    <link rel="stylesheet" href="/kyoCall/modal.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/fonts/css/all.css">
    <link rel = "icon" href ="/icon.ico" type = "image/x-icon">
</head>
<body>


     <div id="$main" class="a a-mobile-camera bg-light" >
       <video id='$remoteStream' class="d-none" autoplay></video>
        <div id='$info' class="text-center small m-auto">
          <img style="width: 200px;" src="/kyoCall/bigLogo.png" alt="">
          <p>POWRED BY PEERAS</p>
          <img src="/logo.svg" alt="">
            <div id='$infoText' class="alert alert-info alert-dismissible fade show">
              <i class="fa fa-cog fa-spin fa-2x fa-fw"></i> Acceccing the user mic and camera
             </div>
        </div>
        <!-- B -->
        <div class="b">
          <video id='$myStream' muted autoplay></video>
          <button id='$hideLocalStreamBtn' style="border-radius: 0;" class="btn btn-dark w-100 d-none"><i class="fa fa-eye"></i></button>
        </div>
        <div id="$d" class="d">
          <img id="$logo" width="100" src="/kyoCall/logo.png" alt=""><br>
          <i class="fa fa-stopwatch" ></i> <span id="$timer">connecting...</span><br>
        </div>

             <div class="c p-3">
      <div>
          <button id='$close' class="btn btn-danger" ><i class="fa fa-phone-slash"></i></button>
 <button id="$muteMic" class="btn btn-dark" ><i class="fa fa-microphone"></i></button>
  <button id="$muteCam" class="btn btn-dark" ><i class="fa fa-video"></i></button>
  <button id="$changeWeightBtn" class="btn btn-dark" ><i class="fa fa-laptop"></i></button>
  <button id="$screenShot" class="btn btn-dark" ><i class="fa fa-camera"></i></button> 
      </div>
</div> 
     </div>
 



</body>

</html>

<script>

const socket = io('/');
const P2P = new PEERAS()

navigator.mediaDevices.getUserMedia({ audio: true, video: true})
   .then(function (stream) {
         if (stream.getVideoTracks().length > 0 && stream.getAudioTracks().length > 0)
         return START_APP(stream)      
         return SHOW_ERROR('No Tracks founds')
        })
   .catch(err => {
     console.log(err)
     SHOW_ERROR(err.toString())
   });

   

function SHOW_ERROR(error){
  $info.innerHTML = 
       `<img src="/logo.svg" alt="">
       <div class="alert alert-danger alert-dismissible fade show">
       <strong>Error!</strong> ${error}
       </div>`
}

async function START_APP(localStream){

    //SHOW LOCAL STREAM ON THE DOM
    $myStream.srcObject = localStream
    $hideLocalStreamBtn.classList.remove('d-none')
    
    //GET AND SHOW CURRENT ROOM ID
    let call = null
    const roomId  = location.pathname.split('/').pop()
    $infoText.innerHTML = `<i class="fa fa-cog fa-spin fa-2x fa-fw"></i> Waiting for the other user to join your room <b>${roomId}</b>`
   
    //--- PEERAS LOGIC---//
const eventListener = {
        onConnecting : ()=>{
          $infoText.textContent = 'connecting...'
        },
        onFailed : ()=>console.log('failed'),
        onOpen : streams => {
            console.log("connexion opned!!!")
            $remoteStream.srcObject = streams[0]
            $remoteStream.className = ''
            $info.classList.add('d-none')
            START_TIMER()
        },
        onClose : () => {
            console.log('socket left')
            $remoteStream.className = 'd-none'
            $info.classList.remove('d-none')
            $infoText.textContent = 'call closed, if the user join the room again it will inizlize'
            TIMER_POOSED = true
        },
      onRemoteStreamChanges : info => {
        /*
        state: false
        streamIndex: 0
        streamStateChanged: true
        type: "video"
        */
        console.log(info)  
      } 
    }

    socket.on('userJoin',async joinedSocket =>{
    console.log('user joined')  
    call = await P2P.createCall(eventListener,[localStream])
    socket.emit('call',{ socketId : joinedSocket , callId : call.sdp })
    })

    socket.on('call',async ({callerSocketId,callId})=>{
        console.log('user calling')  
        call = await P2P.answerCall(callId,eventListener,[localStream])
        socket.emit('answer',{callerSocketId, answerId : call.sdp})
    })

    socket.on('answer',async answerId =>{
      console.log('call type = ',P2P.checkCallOrAnswerType(answerId))
      const answer = await call.verifyAnswer(answerId)
    })

    socket.on('left', ()=> call.close() )

    socket.on('alert', message=> alert(message))

    socket.emit('join',roomId)


/*---------- APP FUNCTIONS----------*/ 
//--CHANGE WEIGHT--//
$changeWeightBtn.onclick =  function(){ 
if($main.className.includes('mobile'))
{
  $main.classList.remove('a-mobile-camera')
  $changeWeightBtn.getElementsByTagName('i')[0].className = 'fa fa-mobile-alt'
}
else
{
  $main.classList.add('a-mobile-camera')
  $changeWeightBtn.getElementsByTagName('i')[0].className = 'fa fa-laptop'
}
}
//-- --//
$muteMic.onclick = function(){
  const element = $muteMic.getElementsByTagName('i')[0]
  if(element.className.includes('slash'))
  {
    element.className = 'fa fa-microphone'
    call.myMediaStreams[0].audio.resume()
  }
  else
  {
    element.className = 'fa fa-microphone-slash'
    call.myMediaStreams[0].audio.stop()
  }
}
//-- --//
$muteCam.onclick = function(){
  const element = $muteCam.getElementsByTagName('i')[0]
  if(element.className.includes('slash'))
  {
    element.className = 'fa fa-video'
    call.myMediaStreams[0].video.resume()
  }
  else
  {
    element.className = 'fa fa-video-slash'
    call.myMediaStreams[0].video.stop()
  }
}

$close.onclick = ()=>{
  call.close()
}

//-- --//
$hideLocalStreamBtn.onclick = function(){
  const element = $hideLocalStreamBtn.getElementsByTagName('i')[0]
  if(element.className.includes('slash'))
  {
    element.className = 'fa fa-eye'
    $myStream.className = ''
  }
  else
  {
    element.className = 'fa fa-eye-slash'
    $myStream.className = 'd-none'
  }
}
//ss
$screenShot.onclick = function (){
  const soundEffect = new Audio()
  soundEffect.src = "/kyoCall/effect.mp3"
  soundEffect.play()
  const canvas = document.createElement("canvas");
  canvas.getContext("2d").drawImage($remoteStream, 0, 0);
  const dataURL = canvas.toDataURL("image/jpeg");
  const dm = document.createElement('div')
  dm.className = "modal-window"
  dm.innerHTML = `
  <div>
    <img class="w-100 shadow" src="${dataURL}" alt="screenshot">
    <a href="${dataURL}" class="btn btn-dark mt-1" download="kyocall-screenshot" ><i class="fa fa-download"></i> download</a>
    <button onclick="document.getElementsByClassName('modal-window')[0].remove()" class="btn btn-danger mt-1 float-right" >close</button>
    </div>
  `
  document.body.appendChild(dm)

  /*
  const imageData = canvas.getContext("2d").getImageData(0,0,100,30) //width and height of the kc icon in the conrner
  let totalR = 0;
  let totalB = 0;
  let totalG = 0;
 
for(var i = 0; i+4 < imageData.data.length; i+=4) {
  totalR+=imageData.data[i]
  totalB+=imageData.data[i+1]
  totalG+=imageData.data[i+2]
    //a is i+3
}
const diviser = imageData.data.length/4
console.log(totalR/diviser,totalB/diviser,totalG/diviser) //avrage 
if(totalR/diviser<100 && totalB/diviser<100 && totalG/diviser<100)
console.log('its black')
$logo.src = '/kyoCall/logoWhite.png'
$d.className = 'd text-white'
*/
}


var seconds = 0;
var munites = 0;
var hours = 0;
var TIMER_POOSED = false
function START_TIMER(){
if(TIMER_POOSED)
return TIMER_POOSED= false;
setInterval(function(){
    
    let s = seconds<10 ? ':0'+seconds : ':'+seconds  ;
    let m = munites<10 ? ':0'+munites : ':'+munites  ;
    let h = hours<10 ? '0'+hours : ''+hours  ;
    $timer.textContent = h+m+s
  
  if(!TIMER_POOSED)  
  seconds++;
  if(seconds==60)
  {
    seconds=0;
    munites++;
    if(munites==60)
    {
      munites=0;
      hours++;
    }
  }
},1000)
}

//https://www.w3.org/TR/screen-capture/
//https://github.com/webrtc/samples/blob/gh-pages/src/content/getusermedia/filter/js/main.js
/*

captureVideoButton.onclick = function () {
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(handleSuccess)
    .catch(handleError);
};

function handleSuccess(stream) {
  video.srcObject = stream;
}

*/



}

</script>
