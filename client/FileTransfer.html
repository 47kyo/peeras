<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/peeras.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>PEERAS</title>
    <link rel = "icon" href ="/icon.ico" type = "image/x-icon">
  </head>
  <style>
  html,
body {
  height: 100%;
}
.form-check-label{
  font-size: 13px;
}
button{
  width: 100px;
}

.messages{
  border: 1px solid grey; 
  border-radius: 3px;
  height: 160px;
  overscroll-behavior: auto; 
  overflow-y: scroll;
  padding: 8px;
}
.messages p{
  margin: 0px;
}

  </style>
  <body>
    <div class="d-flex h-100 bg-light" >
        <div id="$main" style="max-width: 500px;" class="m-auto p-5">
            <div  class="mb-4">
                <img src="/logo.svg">
                <div class="form-text" >
                Share your room ID <strong id="roomID"></strong> with who you want to transfer files with. The Browser compatibility so far are
                just <strong>Chrome</strong> and <strong>Edge</strong> Im working to add more browsers support soon. 
               </div>
            </div>
            <small id='info'>
              <div id='$infoText' class="alert alert-info alert-dismissible fade show">
                waiting for the other user to join your room<span id='$points'></span>
               </div>
            </small>
            <div id="uploadBlock" class="d-none">
              <div class="mb-3">
                <label for="formFile" class="form-label">Default file input example</label>
                <input class="form-control" type="file" id="formFile">
              </div>
              <div class="progress">
                <div class="progress-bar" id='progressbar' role="progressbar" style="width: 0%"  aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <button onclick="sendfile()" id='sendButton' class="btn btn-outline-dark mt-3">Send File</button>
              <button onclick="Abort()" id='CancelButton' class="btn btn-outline-danger mt-3" style="display: none;">Cancel</button>
              <div id='success' class="alert alert-success alert-dismissible fade show mt-3" style="display: none;">File has been sent successfully</div>
             <div class="mt-3">
              <p>here progress bar if you are getting a file</p>
              <div class="progress">
                <div id='$downloadProgress' class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              </div>
             <!-- Warning Alert -->
             <div id='warning' class="alert alert-warning alert-dismissible fade show my-3" style="display: none;"></div>
              <!-- Warning Alert -->
              <div class="mt-3">
              <p>Recived messages will be displayed here</p>
              <div id='$messages' class="messages"></div>
              <div class="input-group my-2">
                <input id='$myMessage' type="text" class="form-control" placeholder="write your message here" aria-label="Recipient's username">
                <button onclick="sendMessage()" class="btn btn-outline-secondary" type="button" id="button-addon2">SEND</button>
              </div>
              </div>
            </div>
          </div>
    </div>
</body>
</html>
<script>

    const socket = io('/');
    const P2P = new PEERAS()
    
    const roomId  = location.pathname.split('/').pop()
    roomID.textContent = roomId

    let call

    const eventListener = {
        onConnecting : ()=>{
          $infoText.innerHTML = "connecting<span id='$points'></span>"
        },
        onFailed : ()=>console.log('failed'),
        onOpen : streams => {
            //no stream will be recived
            console.log('connexion opned')
            uploadBlock.classList.remove('d-none')
            info.classList.add('d-none')
        },
        onClose : () => {
          console.log('connexion closed!!')
          uploadBlock.classList.add('d-none')
          info.classList.remove('d-none')
          $infoText.innerHTML = "waiting for the other user to join your room<span id='$points'></span>"
        },
        onMessage : message=>{
          const p = document.createElement('p')
          p.textContent = message
          $messages.appendChild(p)
          $messages.scrollTop = 1000000000
        },
        onUploadProgress : percentage =>{
          console.log('file uploading '+percentage+'%')
          progressbar.style.width = percentage.toFixed(2)+'%'
          progressbar.textContent = percentage.toFixed(2)+'%'
          if(percentage==100)
          {
            success.style.display = 'block'
            CancelButton.style.display = 'none'
            sendButton.style.display = 'block'
            formFile.disabled = false
          }
        },
        onDownloadProgress : percentage =>{
          console.log('file downloading '+percentage+'%')
          //$downloadProgress.style.display = 'block'
          $downloadProgress.style.width = percentage.toFixed(2)+'%'
          $downloadProgress.textContent = percentage.toFixed(2)+'%'
        },
        onFileError : errorCode => {
           if(errorCode==1)
           warning.innerHTML = '<strong>Warning!</strong> the user Abort the request to recive your file'
           else if(errorCode==2)
           warning.innerHTML = '<strong>Warning!</strong> the user is not currently on the browser to recive your file'
           warning.style.display = 'block'
           CancelButton.style.display = 'none'
           sendButton.style.display = 'block'
           formFile.disabled = false
        },
        onFileAbort : ()=>{
          warning.innerHTML = '<strong>Warning!</strong> the user canceled the file'
           warning.style.display = 'block'
        }
    }

    socket.on('userJoin',async joinedSocket =>{
    call = await P2P.createCall(eventListener)
    socket.emit('call',{ socketId : joinedSocket , callId : call.sdp })
    })

    socket.on('call',async ({callerSocketId,callId})=>{

        console.log('call type = ',P2P.checkCallOrAnswerType(callId))
         call = await P2P.answerCall(callId,eventListener)
        socket.emit('answer',{callerSocketId, answerId : call.sdp})
    })

    socket.on('answer',async answerId =>{
      console.log('call type = ',P2P.checkCallOrAnswerType(answerId))
        const answer = await call.verifyAnswer(answerId)
    })

    socket.on('left', ()=> {
      console.log('socket left')
      call.close()
    })

    socket.on('alert', message=> alert(message))


    socket.emit('join',roomId)



    async function sendfile() {
      const file = formFile.files[0]
      if(!file)
      {
        warning.innerHTML = '<strong>Warning!</strong> no file is chosem.'
        warning.style.display = 'block' 
        return
      }

      //resiting
      progressbar.style.width = '0%'
      progressbar.textContent = ''
      warning.style.display = 'none' //if any
      success.style.display = 'none'
      sendButton.style.display = 'none'
      CancelButton.style.display = 'block'
      formFile.disabled = true

      call.sendFile(file) 

    }


    function Abort(){ //cancel
      progressbar.style.width = '0%'
      progressbar.textContent = ''
      warning.style.display = 'none' //if any
      success.style.display = 'none'
      sendButton.style.display = 'block'
      CancelButton.style.display = 'none'
      formFile.disabled = false
      call.abortFile()
    }

    function sendMessage(){
      const message = call.sendMessage($myMessage.value)
      if(message.error)
      return 0
      $myMessage.value = ''
      
      
    }


    //
    setInterval(function(){
      if($points.textContent=='...')
      return $points.textContent =''
      $points.textContent +='.'

    },200)


</script>
